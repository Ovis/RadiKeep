@using RadiKeep.Logics.Models
@using RadiKeep.Logics.Models.NhkRadiru
@model KeywordReserveViewModel
@{
    var model = Model;

    ViewData["Title"] = "自動予約ルール";

    Dictionary<(string RegionId, string RegionName), List<RadikoStationInformationEntry>> groupedRadikoStationList = model.RadikoStationList
        .GroupBy(station => station.RegionId)
        .OrderBy(group => group.First().RegionOrder)
        .ToDictionary(group => (group.Key,group.First().RegionName), group => group.ToList());

    Dictionary<(string AreaId, string AreaName), List<RadiruStationEntry>> groupedRadiruStationList = model.RadiruStationList
        .GroupBy(station => station.AreaId)
        .ToDictionary(group => (group.Key,group.First().AreaName), group => group.ToList());
}



<section class="section">
    <div class="rk-page-head">
        <h1 class="rk-page-title">自動予約ルール</h1>
        <p class="rk-page-subtitle">キーワード条件に基づく自動予約ルールを管理します。</p>
    </div>
    <div class="rk-table-wrap">
        <table class="table is-fullwidth">
            <thead>
                <tr>
                    <th>順序</th>
                    <th>
                        検索キーワード
                    </th>
                    <th>
                        録音時間範囲
                    </th>
                    <th>
                        録音対象曜日
                    </th>
                    <th>
                        状態
                    </th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="keyword-reserve-table-body">
            </tbody>
            <template id="keyword-reserve-table-body-template">
                <tr>
                    <td class="reserve-order-cell" data-label="順序">
                        <span class="reserve-order-wrap">
                            <span class="reserve-order-handle" title="ドラッグして並び替え" aria-label="ドラッグして並び替え" draggable="true">
                                <i class="fas fa-grip-vertical"></i>
                            </span>
                            <span class="reserve-order-number"></span>
                        </span>
                    </td>
                    <td class="reserve-keyword" data-label="検索キーワード"></td>
                    <td class="reserve-time-span" data-label="録音時間範囲"></td>
                    <td class="target-day-of-week" data-label="録音対象曜日"></td>
                    <td class="reserve-status" data-label="状態"></td>
                    <td data-label="操作">
                        <div class="reserve-actions">
                            <button type="button" class="button move-up-button is-small is-light" title="上へ移動" aria-label="上へ移動">
                                <span class="icon">
                                    <i class="fas fa-arrow-up"></i>
                                </span>
                                <span class="label-text">上へ</span>
                            </button>
                            <button type="button" class="button move-down-button is-small is-light" title="下へ移動" aria-label="下へ移動">
                                <span class="icon">
                                    <i class="fas fa-arrow-down"></i>
                                </span>
                                <span class="label-text">下へ</span>
                            </button>
                            <a href="#" class="button detail-button is-small is-success" title="編集" aria-label="編集">
                                <span class="icon">
                                    <i class="fas fa-pen-to-square"></i>
                                </span>
                                <span class="label-text">編集</span>
                            </a>
                            <a href="#" class="button delete-button is-small is-danger" title="削除" aria-label="削除">
                                <span class="icon">
                                    <i class="fas fa-trash-can"></i>
                                </span>
                                <span class="label-text">削除</span>
                            </a>
                        </div>
                    </td>
                </tr>
            </template>
        </table>
    </div>
</section>

<template id="keyword-reserve-modal-template">
    <div class="modal is-active" id="keyword-reserve-modal">
        <div class="modal-background">
        </div>
        <div class="modal-card keyword-modal-wide">
            <header class="modal-card-head">
                <p class="modal-card-title">自動予約ルールの変更</p>
                <button class="delete" aria-label="close">
                </button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <div class="card" id="radiko-card-header">
                        <header class="card-header">
                            <p class="card-header-title">radiko放送局リスト</p>
                            <button class="card-header-icon">
                                <span class="icon">
                                    <i class="fas fa-angle-down" aria-hidden="true"></i>
                                </span>
                            </button>
                        </header>
                        <div class="card-content hidden">
                            <div class="content">
                                @foreach (var kv in groupedRadikoStationList)
                                {
                                    var regionId = kv.Key.RegionId;
                                    var regionName = kv.Key.RegionName;

                                    <div class="region pb-6">
                                        <div class="field">
                                            <p class="title is-4 mb-3">@regionName</p>
                                            <label class="label">
                                                <input type="checkbox" class="region-checkbox-all" id="@($"all-check-radiko-{regionId}")">この地域の放送局をすべてチェック
                                            </label>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 region-radiko-@($"{regionId}")">
                                            @foreach (var entry in kv.Value.OrderBy(r=>r.StationOrder))
                                            {
                                                <label class="text-sm">
                                                    <input type="checkbox" class="region-checkbox" data-station="@entry.StationId" name="SelectedRadikoStationIds" value="@entry.StationId">@entry.StationName
                                                </label>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <div class="card" id="radiru-card-header">
                        <header class="card-header">
                            <p class="card-header-title">らじる★らじる放送局リスト</p>
                            <button class="card-header-icon">
                                <span class="icon">
                                    <i class="fas fa-angle-down" aria-hidden="true"></i>
                                </span>
                            </button>
                        </header>
                        <div class="card-content hidden">
                            <div class="content">
                                @foreach (var kv in groupedRadiruStationList)
                                {
                                    var areaId = kv.Key.AreaId;
                                    var areaName = kv.Key.AreaName;

                                    <div class="region pb-6">
                                        <div class="field">
                                            <p class="title is-4 mb-3">@areaName</p>
                                            <label class="label">
                                                <input type="checkbox" class="region-checkbox-all" id="@($"all-check-radiru-{areaId}")">この地域の放送局をすべてチェック
                                            </label>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                            @foreach (var stationEntry in kv.Value)
                                            {
                                                <label class="text-sm">
                                                    <input type="checkbox" class="region-checkbox" data-station="@($"{stationEntry.AreaId}:{stationEntry.StationId}")" name="SelectedRadiruStationIds" value="@($"{stationEntry.AreaId}:{stationEntry.StationId}")">@stationEntry.StationName
                                                </label>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                <div class="field pt-3">
                    <label class="label">キーワード</label>
                    <div class="control">
                        <input class="input" type="text" id="keyword">
                    </div>
                </div>
                <label class="checkbox">
                    <input type="checkbox" id="searchTitleOnly" name="searchTitleOnly">タイトルのみを検索する
                </label>
                <div class="field pt-3">
                    <label class="label">タグ</label>
                    <div class="control">
                        <div class="keyword-tag-select-layout">
                            <select class="input" id="keywordTagIds" multiple size="5"></select>
                            <div class="keyword-selected-tags-panel">
                                <div class="is-flex is-justify-content-space-between is-align-items-center">
                                    <span class="is-size-7 has-text-weight-semibold">選択中タグ</span>
                                    <button type="button" id="keywordTagIdsClear" class="button is-small is-light">すべて解除</button>
                                </div>
                                <div id="keywordTagIdsChips" class="keyword-selected-tags-chip-list">
                                    <span class="keyword-selected-tags-empty">未選択</span>
                                </div>
                            </div>
                        </div>
                        <div class="field has-addons keyword-tag-create-inline">
                            <div class="control is-expanded">
                                <input class="input" type="text" id="keywordTagCreateName" placeholder="新しいタグ名">
                            </div>
                            <div class="control">
                                <button type="button" class="button is-light" id="keywordTagCreateButton">+ 作成</button>
                            </div>
                        </div>
                        <div id="keywordTagCreateSuggestions" class="keyword-tag-create-suggestion-list" aria-live="polite"></div>
                    </div>
                </div>
                <div class="field pt-3">
                    <label class="label">除外キーワード</label>
                    <div class="control">
                        <input class="input" type="text" id="excludedKeyword">
                    </div>
                </div>
                <label class="checkbox">
                    <input type="checkbox" id="excludeTitleOnly" name="excludeTitleOnly">タイトルのみを検索する
                </label>
                <div class="field pt-3">
                    <label class="label">曜日</label>
                    <div class="control day-of-weeks">
                        <label class="checkbox pr-4">
                            <input type="checkbox" id="day-of-week-sunday" name="selectedDaysOfWeek" value="1">日曜日
                        </label>
                        <label class="checkbox pr-4">
                            <input type="checkbox" id="day-of-week-monday" name="selectedDaysOfWeek" value="2">月曜日
                        </label>
                        <label class="checkbox pr-4">
                            <input type="checkbox" id="day-of-week-tuesday" name="selectedDaysOfWeek" value="4">火曜日
                        </label>
                        <label class="checkbox pr-4">
                            <input type="checkbox" id="day-of-week-wednesday" name="selectedDaysOfWeek" value="8">水曜日
                        </label>
                        <label class="checkbox pr-4">
                            <input type="checkbox" id="day-of-week-thursday" name="selectedDaysOfWeek" value="16">木曜日
                        </label>
                        <label class="checkbox pr-4">
                            <input type="checkbox" id="day-of-week-friday" name="selectedDaysOfWeek" value="32">金曜日
                        </label>
                        <label class="checkbox pr-4">
                            <input type="checkbox" id="day-of-week-saturday" name="selectedDaysOfWeek" value="64">土曜日
                        </label>
                    </div>
                </div>
                <div class="field pt-3">
                    <label class="label">開始・終了時刻</label>
                    <div class="control">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <input class="input" type="time" id="startTime">
                            </div>
                            <div>
                                <input class="input" type="time" id="endTime">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="field pt-3">
                    <label class="label">番組の保存先</label>
                    <div class="control">
                        <input class="input" type="text" id="recordPath" placeholder="$StationName$\$Title$\$SYYYY$\$SMM$\">
                    </div>
                </div>
                <div class="field pt-3">
                    <label class="label">番組のファイル名</label>
                    <div class="control">
                        <input class="input" type="text" id="recordFileName" placeholder="$SYYYY$$SMM$$SDD$_$Title$">
                    </div>
                </div>
                <div class="field pt-3">
                    <label class="label">リアルタイム予約時の開始時間マージン（秒）</label>
                    <div class="control">
                        <input class="input" type="number" id="startDelay">
                    </div>
                </div>
                <div class="field pt-3">
                    <label class="label">リアルタイム予約時の終了時間マージン（秒）</label>
                    <div class="control">
                        <input class="input" type="number" id="endDelay">
                    </div>
                </div>
                <div class="field pt-3">
                    <label class="label">タグ付与方式（複数ルール一致時）</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="mergeTagBehavior">
                                <option value="0">全体設定に従う</option>
                                <option value="1">常にこのルールのタグを追加する</option>
                                <option value="2">他ルールも一致したときは、このルールのタグを追加しない</option>
                            </select>
                        </div>
                    </div>
                    <p class="help">同じ番組に複数ルールが一致したときの、このルールのタグ追加方法を指定します。</p>
                </div>
                <div class="field pt-3">
                    <label class="label">自動予約ルールの有効・無効</label>
                    <div class="control">
                        <input class="checkbox" type="checkbox" id="enabled">有効
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <div class="buttons">
                    <button class="button is-primary" id="update-button">更新</button>
                    <button class="button" id="cancel-button">キャンセル</button>
                </div>
            </footer>
        </div>
    </div>
</template>

@section scripts {
    <script type="module" src="~/js/keyword-reserve.js" asp-append-version="true"></script>
}
