@using RadiKeep.Logics.Services
@using RadiKeep.Logics.Logics.NotificationLogic
@using RadiKeep.Logics.Models.NhkRadiru
@using RadiKeep.Logics.Primitives.DataAnnotations
@inject IAppConfigurationService AppConfigurationService
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "設定画面";
    var hasRadikoPassword = AppConfigurationService.HasRadikoCredentials;
}

<section class="section">
    <div class="rk-page-head">
        <h1 class="rk-page-title">設定</h1>
        <p class="rk-page-subtitle">録音・通知・ログインなどの各種設定を管理します。</p>
    </div>
        <input id="VerificationToken" type="hidden" value="@(Antiforgery.GetAndStoreTokens(Context).RequestToken)" />
        <nav class="grid grid-cols-2 gap-1 rounded-xl border border-slate-300 bg-slate-100 p-1 mb-6 md:grid-cols-3 lg:flex" aria-label="Setting Tabs">
            <button
                id="setting-tab-general"
                type="button"
                data-setting-tab="general"
                class="inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200">
                <span class="icon is-small"><i class="fas fa-sliders" aria-hidden="true"></i></span>
                <span>一般設定</span>
            </button>
            <button
                id="setting-tab-advanced"
                type="button"
                data-setting-tab="advanced"
                class="inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-sm font-semibold text-slate-700 hover:border-slate-400 hover:bg-white hover:text-slate-900">
                <span class="icon is-small"><i class="fas fa-sliders-h" aria-hidden="true"></i></span>
                <span>詳細設定</span>
            </button>
            <button
                id="setting-tab-tags"
                type="button"
                data-setting-tab="tags"
                class="inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-sm font-semibold text-slate-700 hover:border-slate-400 hover:bg-white hover:text-slate-900">
                <span class="icon is-small"><i class="fas fa-tags" aria-hidden="true"></i></span>
                <span>タグ管理</span>
            </button>
            <button
                id="setting-tab-external-import"
                type="button"
                data-setting-tab="external-import"
                class="inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-sm font-semibold text-slate-700 hover:border-slate-400 hover:bg-white hover:text-slate-900">
                <span class="icon is-small"><i class="fas fa-file-import" aria-hidden="true"></i></span>
                <span>外部取込</span>
            </button>
            <button
                id="setting-tab-maintenance"
                type="button"
                data-setting-tab="maintenance"
                class="inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-sm font-semibold text-slate-700 hover:border-slate-400 hover:bg-white hover:text-slate-900">
                <span class="icon is-small"><i class="fas fa-screwdriver-wrench" aria-hidden="true"></i></span>
                <span>メンテナンス</span>
            </button>
        </nav>

        <div id="setting-panel-general">
        <div class="rk-panel mb-4">
            <div class="content">
                <p class="mb-2 has-text-weight-semibold">一般設定の目次</p>
                <div class="buttons are-small">
                    <a class="button is-light" href="#settings-storage">保存・実行環境</a>
                    <a class="button is-light" href="#settings-notify">通知・監視</a>
                    <a class="button is-light" href="#settings-automation">自動処理</a>
                    <a class="button is-light" href="#settings-release">更新チェック</a>
                </div>
            </div>
        </div>
        <!-- 番組の保存先フォルダパス設定 -->
        <div class="rk-panel">
            <header class="mb-3">
                <h2 id="settings-storage" class="rk-panel-head">番組の保存先フォルダ/ディレクトリパス</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p><code>@($"{AppConfigurationService.RecordFileSaveDir}")</code> の直下に録音したラジオ番組が保存されます。</p>
                    <p>番組ごとにフォルダ/ディレクトリを分けたい場合はこの設定から相対パスで指定してください。</p>
                    <p>自動予約ルールで保存先フォルダ/ディレクトリを指定している場合はそちらが優先されます。</p>
                    <p>設定例: <code>$StationName$/$Title$/$SYYYY$/$SMM$/</code></p>
                </div>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input class="input" type="text" id="record-directory-path-value" value="@AppConfigurationService.RecordDirectoryRelativePath">
                    </div>
                    <div class="control">
                        <button class="button is-primary" id="update-record-directory-path-btn">保存</button>
                    </div>
                </div>
                
                <!-- 説明カード -->
                <div class="card toggle-card" id="directory-explanation-card">
                    <header class="card-header">
                        <p class="card-header-title" style="margin-bottom: 0;">置換文字列一覧（保存先パス）</p>
                        <button class="card-header-icon" aria-label="toggle explanation">
                            <span class="icon">
                                <i class="fas fa-angle-down" aria-hidden="true"></i>
                            </span>
                        </button>
                    </header>
                    <div class="card-content hidden">
                        <div class="content rk-token-help">
                            <p class="rk-token-help-note">以下の文字列は保存時に実際の番組情報へ置換されます。</p>
                            <h4 class="rk-token-help-title">共通</h4>
                            <div class="rk-token-help-grid">
                                <div class="rk-token-help-item"><code>$StationId$</code><span>放送局ID（例: QRR）</span></div>
                                <div class="rk-token-help-item"><code>$StationName$</code><span>放送局名（例: 文化放送）</span></div>
                                <div class="rk-token-help-item"><code>$Title$</code><span>番組名（例: ニュース・交通情報）</span></div>
                            </div>
                            <h4 class="rk-token-help-title">放送開始日時</h4>
                            <div class="rk-token-help-grid">
                                <div class="rk-token-help-item"><code>$SYYYY$</code><span>開始年4桁（例: 2024）</span></div>
                                <div class="rk-token-help-item"><code>$SYY$</code><span>開始年2桁（例: 24）</span></div>
                                <div class="rk-token-help-item"><code>$SMM$</code><span>開始月2桁（例: 04）</span></div>
                                <div class="rk-token-help-item"><code>$SM$</code><span>開始月（例: 4）</span></div>
                                <div class="rk-token-help-item"><code>$SDD$</code><span>開始日2桁（例: 01）</span></div>
                                <div class="rk-token-help-item"><code>$SD$</code><span>開始日（例: 1）</span></div>
                                <div class="rk-token-help-item"><code>$STHH$</code><span>開始時2桁（例: 09）</span></div>
                                <div class="rk-token-help-item"><code>$STH$</code><span>開始時（例: 9）</span></div>
                                <div class="rk-token-help-item"><code>$STMM$</code><span>開始分2桁（例: 00）</span></div>
                                <div class="rk-token-help-item"><code>$STM$</code><span>開始分（例: 0）</span></div>
                                <div class="rk-token-help-item"><code>$STSS$</code><span>開始秒2桁（例: 00）</span></div>
                                <div class="rk-token-help-item"><code>$STS$</code><span>開始秒（例: 0）</span></div>
                            </div>
                            <h4 class="rk-token-help-title">放送終了日時</h4>
                            <div class="rk-token-help-grid">
                                <div class="rk-token-help-item"><code>$EYYYY$</code><span>終了年4桁（例: 2024）</span></div>
                                <div class="rk-token-help-item"><code>$EYY$</code><span>終了年2桁（例: 24）</span></div>
                                <div class="rk-token-help-item"><code>$EMM$</code><span>終了月2桁（例: 04）</span></div>
                                <div class="rk-token-help-item"><code>$EM$</code><span>終了月（例: 4）</span></div>
                                <div class="rk-token-help-item"><code>$EDD$</code><span>終了日2桁（例: 01）</span></div>
                                <div class="rk-token-help-item"><code>$ED$</code><span>終了日（例: 1）</span></div>
                                <div class="rk-token-help-item"><code>$ETHH$</code><span>終了時2桁（例: 09）</span></div>
                                <div class="rk-token-help-item"><code>$ETH$</code><span>終了時（例: 9）</span></div>
                                <div class="rk-token-help-item"><code>$ETMM$</code><span>終了分2桁（例: 00）</span></div>
                                <div class="rk-token-help-item"><code>$ETM$</code><span>終了分（例: 0）</span></div>
                                <div class="rk-token-help-item"><code>$ETSS$</code><span>終了秒2桁（例: 00）</span></div>
                                <div class="rk-token-help-item"><code>$ETS$</code><span>終了秒（例: 0）</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 番組録音時のファイル名設定 -->
        <div class="rk-panel">
            <header class="mb-3">
                <h2 class="rk-panel-head">ラジオ番組のファイル名</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>デフォルトのファイル名は<code>放送開始日(yyyyMMddHHmmss)_{ラジオ番組タイトル}.m4a</code>です。</p>
                    <p>変更したい場合はこの設定から変更してください。</p>
                    <p>自動予約ルールで指定している場合はそちらが優先されます。</p>
                    <p>ファイルの拡張子はm4a固定です。</p>
                    <p>設定例: <code>$SYYYY$$SMM$$SDD$_$Title$</code></p>
                </div>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input class="input" type="text" id="RecordFileNameTemplateValue" value="@AppConfigurationService.RecordFileNameTemplate">
                    </div>
                    <div class="control">
                        <button class="button is-primary" id="UpdateRecordFileNameTemplateBtn">保存</button>
                    </div>
                </div>

                <!-- 説明カード -->
                <div class="card toggle-card" id="file-name-explanation-card">
                    <header class="card-header">
                        <p class="card-header-title" style="margin-bottom: 0;">置換文字列一覧（ファイル名）</p>
                        <button class="card-header-icon" aria-label="toggle explanation">
                            <span class="icon">
                                <i class="fas fa-angle-down" aria-hidden="true"></i>
                            </span>
                        </button>
                    </header>
                    <div class="card-content hidden">
                        <div class="content rk-token-help">
                            <p class="rk-token-help-note">以下の文字列は保存時に実際の番組情報へ置換されます。</p>
                            <h4 class="rk-token-help-title">共通</h4>
                            <div class="rk-token-help-grid">
                                <div class="rk-token-help-item"><code>$StationId$</code><span>放送局ID（例: QRR）</span></div>
                                <div class="rk-token-help-item"><code>$StationName$</code><span>放送局名（例: 文化放送）</span></div>
                                <div class="rk-token-help-item"><code>$Title$</code><span>番組名（例: ニュース・交通情報）</span></div>
                            </div>
                            <h4 class="rk-token-help-title">放送開始日時</h4>
                            <div class="rk-token-help-grid">
                                <div class="rk-token-help-item"><code>$SYYYY$</code><span>開始年4桁（例: 2024）</span></div>
                                <div class="rk-token-help-item"><code>$SYY$</code><span>開始年2桁（例: 24）</span></div>
                                <div class="rk-token-help-item"><code>$SMM$</code><span>開始月2桁（例: 04）</span></div>
                                <div class="rk-token-help-item"><code>$SM$</code><span>開始月（例: 4）</span></div>
                                <div class="rk-token-help-item"><code>$SDD$</code><span>開始日2桁（例: 01）</span></div>
                                <div class="rk-token-help-item"><code>$SD$</code><span>開始日（例: 1）</span></div>
                                <div class="rk-token-help-item"><code>$STHH$</code><span>開始時2桁（例: 09）</span></div>
                                <div class="rk-token-help-item"><code>$STH$</code><span>開始時（例: 9）</span></div>
                                <div class="rk-token-help-item"><code>$STMM$</code><span>開始分2桁（例: 00）</span></div>
                                <div class="rk-token-help-item"><code>$STM$</code><span>開始分（例: 0）</span></div>
                                <div class="rk-token-help-item"><code>$STSS$</code><span>開始秒2桁（例: 00）</span></div>
                                <div class="rk-token-help-item"><code>$STS$</code><span>開始秒（例: 0）</span></div>
                            </div>
                            <h4 class="rk-token-help-title">放送終了日時</h4>
                            <div class="rk-token-help-grid">
                                <div class="rk-token-help-item"><code>$EYYYY$</code><span>終了年4桁（例: 2024）</span></div>
                                <div class="rk-token-help-item"><code>$EYY$</code><span>終了年2桁（例: 24）</span></div>
                                <div class="rk-token-help-item"><code>$EMM$</code><span>終了月2桁（例: 04）</span></div>
                                <div class="rk-token-help-item"><code>$EM$</code><span>終了月（例: 4）</span></div>
                                <div class="rk-token-help-item"><code>$EDD$</code><span>終了日2桁（例: 01）</span></div>
                                <div class="rk-token-help-item"><code>$ED$</code><span>終了日（例: 1）</span></div>
                                <div class="rk-token-help-item"><code>$ETHH$</code><span>終了時2桁（例: 09）</span></div>
                                <div class="rk-token-help-item"><code>$ETH$</code><span>終了時（例: 9）</span></div>
                                <div class="rk-token-help-item"><code>$ETMM$</code><span>終了分2桁（例: 00）</span></div>
                                <div class="rk-token-help-item"><code>$ETM$</code><span>終了分（例: 0）</span></div>
                                <div class="rk-token-help-item"><code>$ETSS$</code><span>終了秒2桁（例: 00）</span></div>
                                <div class="rk-token-help-item"><code>$ETS$</code><span>終了秒（例: 0）</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 録音時間のマージン -->
        <div class="rk-panel">
            <header class="mb-3">
                <h2 class="rk-panel-head">録音時間のマージン</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>録音時間の開始と終了にマージンを設けることで、番組の開始終了がずれて中途半端に録音される事故が発生する確率が減少します。</p>
                    <p>※radikoとらじる★らじるのリアルタイム録音の場合のみ適用されます。</p>
                </div>
                <div class="md:hidden">
                    <div class="field">
                        <label class="label">録音開始のマージン（秒）</label>
                        <div class="control">
                            <input class="input" id="record-start-duration-value" type="number" placeholder="録音開始のマージンを秒単位で入力" value="@AppConfigurationService.RecordStartDuration.TotalSeconds">
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">録音終了のマージン（秒）</label>
                        <div class="control">
                            <input class="input" id="record-end-duration-value" type="number" placeholder="録音終了のマージンを秒単位で入力" value="@AppConfigurationService.RecordEndDuration.TotalSeconds">
                        </div>
                    </div>
                    <div class="field">
                        <div class="control">
                            <button class="button is-primary" id="update-record-duratioh-btn">保存</button>
                        </div>
                    </div>
                </div>

                <div class="hidden md:block">
                    <div class="columns is-multiline is-desktop">
                        <div class="column">
                            <div class="field">
                                <label class="label">録音開始のマージン（秒）</label>
                                <div class="control">
                                    <input class="input" id="record-start-duration-value-desktop" type="number" placeholder="録音開始のマージンを秒単位で入力" value="@AppConfigurationService.RecordStartDuration.TotalSeconds">
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="field">
                                <label class="label">録音終了のマージン（秒）</label>
                                <div class="control">
                                    <input class="input" id="record-end-duration-value-desktop" type="number" placeholder="録音終了のマージンを秒単位で入力" value="@AppConfigurationService.RecordEndDuration.TotalSeconds">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 保存ボタン -->
                    <div class="field">
                        <div class="control">
                            <button class="button is-primary" id="update-record-duratioh-btn-desktop">保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="rk-panel">
            <header class="mb-3">
                <h2 class="rk-panel-head">録音ファイルへの番組イメージ埋め込み</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>番組のイメージ画像がある場合、録音完了後にカバーアートとして埋め込みを試行します。</p>
                    <p>画像取得失敗時は、録音ファイルの保存処理を継続します。</p>
                </div>
                <div class="field is-grouped is-align-items-center">
                    <div class="control">
                        <label class="checkbox">
                            <input type="checkbox" id="embed-program-image-on-record" @(AppConfigurationService.EmbedProgramImageOnRecord ? "checked" : "") />
                            番組イメージがある場合は埋め込みを行う
                        </label>
                    </div>
                    <div class="control">
                        <button class="button is-primary" id="update-embed-program-image-on-record-btn">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="rk-panel">
            <header class="mb-3">
                <h2 class="rk-panel-head">ページ遷移時の再生復帰</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>再生中に別ページへ移動した場合、再生状態（再生位置・速度）を復帰します。</p>
                    <p>ブラウザを閉じて開き直した場合は復帰しません。</p>
                </div>
                <div class="field is-grouped is-align-items-center">
                    <div class="control">
                        <label class="checkbox">
                            <input type="checkbox" id="resume-playback-across-pages" @(AppConfigurationService.ResumePlaybackAcrossPages ? "checked" : "") />
                            ページ移動後も再生状態を引き継ぐ
                        </label>
                    </div>
                    <div class="control">
                        <button class="button is-primary" id="update-resume-playback-across-pages-btn">保存</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- radikoログイン設定 -->
        <div class="rk-panel">
            <header class="mb-3">
                <h2 class="rk-panel-head">radikoログイン設定</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>エリア外の番組を録音する場合、radikoログインが必要です。</p>
                </div>
                <div class="field pt-3">
                    <label class="label">radikoログインメールアドレス</label>
                    <div class="control is-expanded">
                        <input class="input" type="email" id="RadikoUserId" value="@AppConfigurationService.RadikoOptions.RadikoUserId" placeholder="mail@example.com">
                    </div>
                </div>
                <div class="field pt-3">
                    <label class="label">radikoログインパスワード</label>
                    <div class="control is-expanded">
                        <input class="input" type="password" id="RadikoPassword" value="" placeholder="********" autocomplete="new-password">
                    </div>
                    @if (hasRadikoPassword)
                    {
                        <p id="RadikoPasswordSavedNote" class="text-xs text-zinc-500 mt-2">現在パスワードは保存済みです。変更する場合のみ入力してください。</p>
                    }
                </div>
                <div class="field pt-3 is-grouped">
                    <div class="control">
                        <button class="button is-primary" id="update-radiko-login-btn">保存</button>
                    </div>
                    <div class="control">
                        <button class="button is-light" id="clear-radiko-login-btn">ログアウト</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="rk-panel">
            <header class="mb-3">
                <h2 class="rk-panel-head">radikoエリア情報</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>radikoの現在エリア判定結果は一定時間キャッシュされます。</p>
                    <p>ネットワーク環境を変更した場合は、必要に応じて再判定してください。</p>
                </div>
                <div class="field">
                    <div class="control">
                        <button class="button is-light" id="refresh-radiko-area-btn">エリアを再判定</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- らじる★らじるで利用する放送エリア（自動予約ルール用） -->
        <div class="rk-panel">
            <header class="mb-3">
                <h2 class="rk-panel-head">らじる★らじるで利用する放送エリア（自動予約ルール用）</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>キーワード検索による自動予約で、らじる★らじるの複数のエリアで同一番組が放送されている場合に録音を行うエリアを指定します。</p>
                    <p>デフォルトは東京です。</p>
                    <p>指定したエリア以外で配信され、かつ複数のエリアで放送している場合はその中から1つの放送局だけ録音します。</p>
                </div>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <div class="select is-fullwidth">
                            <select id="RadiruArea" name="RadiruArea">
                                @foreach (var area in Enum.GetValues<RadiruAreaKind>())
                                {
                                    <option name="@(area.GetEnumCodeId())" value="@(area.GetEnumCodeId())" selected="@(AppConfigurationService.RadiruArea == area.GetEnumCodeId())">@area.ToString()</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="control">
                        <button class="button is-primary" id="UpdateRadiruAreaBtn">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 番組表の手動更新ボタン -->
        <div class="rk-panel">
            <header class="mb-3">
                <h2 class="rk-panel-head">番組表の手動更新</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>番組表を手動で更新します。必要なときにボタンをクリックしてください。</p>
                </div>
                <div class="field">
                    <div class="control">
                        <button class="button is-warning" id="update-program-btn">番組表を更新</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- お知らせの未読件数設定 -->
        <div class="rk-panel">
            <header class="mb-3">
                <h2 id="settings-notify" class="rk-panel-head">お知らせの未読件数設定</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>右上のベルアイコンに表示する未読件数に含めるカテゴリを指定します。</p>
                    <p>ここで除外したカテゴリはお知らせに登録されますが、未読件数には加算されません。</p>
                    <p>Discord通知対象カテゴリとは別設定です。</p>
                </div>
                <div class="field pt-3">
                    <label class="label">未読件数に含めるカテゴリ</label>
                    <div class="control ml-3">
                        @foreach (NoticeCategory category in Enum.GetValues(typeof(NoticeCategory)))
                        {
                            if (category != NoticeCategory.Undefined)
                            {
                                var isChecked = AppConfigurationService.UnreadBadgeNoticeCategories.Contains(category);
                                <label class="checkbox pr-4">
                                    <input type="checkbox" name="SelectedUnreadBadgeNoticeCategory" value="@((int)category)" checked="@isChecked" />
                                    @category.GetEnumDisplayName() 
                                </label><br />
                            }
                        }
                    </div>
                </div>
                <div class="field pt-3">
                    <div class="control">
                        <button class="button is-primary" id="update-unread-badge-notice-categories-btn">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Discord通知設定 -->
        <div class="rk-panel">
            <header class="mb-3">
                <h2 class="rk-panel-head">Discord通知設定</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>録音が完了した場合やエラーが発生したといったタイミングでDiscordに通知を送ることができます。</p>
                    <p>通知対象となるカテゴリも指定が可能です。</p>
                </div>
                <div class="field pt-3">
                    <label class="label">Discord通知用WebhookURL</label>
                    <div class="control is-expanded">
                        <input class="input" type="text" id="DiscordWebhookUrl" value="@AppConfigurationService.DiscordWebhookUrl" placeholder="https://discord.com/api/webhooks/123456789012345678/-ToKeNToKeNtOkEn_tOkEnToKenT_okEn">
                    </div>
                </div>
                <div class="field pt-3">
                    <label class="label">通知対象カテゴリ</label>
                    <div class="control ml-3">
                        @foreach (NoticeCategory category in Enum.GetValues(typeof(NoticeCategory)))
                        {
                            if (category != NoticeCategory.Undefined)
                            {
                                var isChecked = AppConfigurationService.NoticeCategories.Contains(category);
                                <label class="checkbox pr-4">
                                    <input type="checkbox" id="day-@category" name="SelectedNoticeCategory" value="@((int)category)" checked="@isChecked" />
                                    @category.GetEnumDisplayName()
                                </label><br/>
                            }
                        }
                    </div>
                </div>
                <!-- 保存ボタン -->
                <div class="field pt-3">
                    <div class="control">
                        <button class="button is-primary" id="update-notice-setting-btn">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ストレージ空き容量通知設定 -->
        <div class="rk-panel">
            <header class="mb-3">
                <h2 class="rk-panel-head">保存先ストレージ空き容量通知</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>録音保存先ストレージの空き容量がしきい値を下回った場合に通知します。</p>
                    <p>しきい値はMB単位で指定します。</p>
                </div>
                <div class="field">
                    <div class="flex items-center gap-2">
                        <div class="flex-1">
                            <input class="input" type="number" min="1" max="@int.MaxValue" step="1" id="storage-low-space-threshold-mb-value" value="@AppConfigurationService.StorageLowSpaceThresholdMb">
                        </div>
                        <button class="button is-static shrink-0" type="button" tabindex="-1">MB</button>
                        <button class="button is-primary shrink-0" id="update-storage-low-space-threshold-btn">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="rk-panel">
            <header class="mb-3">
                <h2 id="settings-automation" class="rk-panel-head">自動予約タグ付与の挙動</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>同じ番組が複数の自動予約ルールに一致した場合に、各ルールのタグをまとめて付与するかを指定します。</p>
                    <p>「有効」にすると、個別ルールで「追加しない」にしたルール以外のタグを付与します。</p>
                    <p>個別ルール側で「常に追加する / 他ルール一致時は追加しない」を選んだ場合は、そちらが優先されます。</p>
                </div>
                <div class="field is-grouped is-align-items-center">
                    <div class="control">
                        <label class="checkbox">
                            <input type="checkbox" id="merge-tags-from-matched-rules-enabled" checked="@AppConfigurationService.MergeTagsFromAllMatchedKeywordRules">
                            複数ルール一致時にタグを統合して付与する
                        </label>
                    </div>
                    <div class="control">
                        <button class="button is-primary" id="update-merge-tags-from-matched-rules-btn">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="rk-panel">
            <header class="mb-3">
                <h2 class="rk-panel-head">類似番組抽出の定期実行</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>録音済み番組から類似内容の候補を抽出する処理を定期実行します。</p>
                    <p>抽出完了時はお知らせへ結果を通知します。</p>
                </div>
                <div class="md:hidden">
                    <div class="field">
                        <label class="checkbox">
                            <input type="checkbox" id="duplicate-detection-enabled" @(AppConfigurationService.DuplicateDetectionIntervalDays > 0 ? "checked" : "") />
                            定期実行を有効にする
                        </label>
                    </div>
                    <div class="field">
                        <label class="label">実行曜日</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="duplicate-detection-day-of-week">
                                    <option value="0" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 0)">日曜日</option>
                                    <option value="1" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 1)">月曜日</option>
                                    <option value="2" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 2)">火曜日</option>
                                    <option value="3" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 3)">水曜日</option>
                                    <option value="4" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 4)">木曜日</option>
                                    <option value="5" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 5)">金曜日</option>
                                    <option value="6" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 6)">土曜日</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">実行時刻</label>
                        <div class="control">
                            <input class="input" id="duplicate-detection-time" type="time" value="@($"{AppConfigurationService.DuplicateDetectionScheduleHour:D2}:{AppConfigurationService.DuplicateDetectionScheduleMinute:D2}")" />
                        </div>
                    </div>
                    <div class="field">
                        <div class="control">
                            <button class="button is-primary" id="update-duplicate-detection-interval-btn">保存</button>
                        </div>
                    </div>
                </div>

                <div class="hidden md:block">
                    <div class="field">
                        <label class="checkbox">
                            <input type="checkbox" id="duplicate-detection-enabled-desktop" @(AppConfigurationService.DuplicateDetectionIntervalDays > 0 ? "checked" : "") />
                            定期実行を有効にする
                        </label>
                    </div>
                    <div class="columns is-multiline is-desktop">
                        <div class="column">
                            <label class="label">実行曜日</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="duplicate-detection-day-of-week-desktop">
                                        <option value="0" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 0)">日曜日</option>
                                        <option value="1" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 1)">月曜日</option>
                                        <option value="2" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 2)">火曜日</option>
                                        <option value="3" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 3)">水曜日</option>
                                        <option value="4" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 4)">木曜日</option>
                                        <option value="5" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 5)">金曜日</option>
                                        <option value="6" selected="@(AppConfigurationService.DuplicateDetectionScheduleDayOfWeek == 6)">土曜日</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <label class="label">実行時刻</label>
                            <div class="control">
                                <input class="input" id="duplicate-detection-time-desktop" type="time" value="@($"{AppConfigurationService.DuplicateDetectionScheduleHour:D2}:{AppConfigurationService.DuplicateDetectionScheduleMinute:D2}")" />
                            </div>
                        </div>
                        <div class="column is-narrow">
                            <label class="label">&nbsp;</label>
                            <div class="control">
                                <button class="button is-primary" id="update-duplicate-detection-interval-btn-desktop">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <p class="help">有効時は指定した曜日・時刻に毎週実行します。</p>
                </div>
            </div>
        </div>

        <div class="rk-panel">
            <header class="mb-3">
                <h2 id="settings-release" class="rk-panel-head">新しいリリースの確認</h2>
            </header>
            <div class="content">
                <div class="rk-setting-summary">
                    <p>GitHubの最新リリースを定期確認し、更新がある場合にお知らせへ通知します。</p>
                </div>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <div class="select is-fullwidth">
                            <select id="release-check-interval-days">
                                <option value="0" selected="@(AppConfigurationService.ReleaseCheckIntervalDays <= 0)">確認しない</option>
                                <option value="1" selected="@(AppConfigurationService.ReleaseCheckIntervalDays == 1)">1日ごと</option>
                                <option value="7" selected="@(AppConfigurationService.ReleaseCheckIntervalDays == 7)">7日ごと</option>
                                <option value="30" selected="@(AppConfigurationService.ReleaseCheckIntervalDays == 30)">30日ごと</option>
                            </select>
                        </div>
                    </div>
                    <div class="control">
                        <button class="button is-primary" id="update-release-check-interval-btn">保存</button>
                    </div>
                </div>
            </div>
        </div>

        </div>

        <div id="setting-panel-advanced" class="hidden">
            <div class="rk-panel">
                <header class="mb-3">
                    <h2 class="rk-panel-head">詳細設定（通常は変更不要）</h2>
                </header>
                <div class="content">
                    <div class="rk-setting-summary">
                        <p>通信制御や監視間隔など、通常運用では変更しない上級者向け項目です。</p>
                        <p>不明な場合は既定値のまま利用してください。</p>
                    </div>
                </div>
            </div>

            <div class="rk-panel">
                <header class="mb-3">
                    <h2 class="rk-panel-head">外部サービス接続時の識別情報（User-Agent）</h2>
                </header>
                <div class="content">
                    <div class="rk-setting-summary">
                        <p>番組情報の取得など、外部サービスへ接続する際に送信する識別情報です。</p>
                        <p>接続エラー時のみ変更してください。通常は初期値のまま利用してください。</p>
                    </div>
                    <div class="field has-addons">
                        <div class="control is-expanded">
                            <input class="input" type="text" id="ExternalServiceUserAgent" value="@AppConfigurationService.ExternalServiceUserAgent">
                        </div>
                        <div class="control">
                            <button class="button is-primary" id="UpdateExternalServiceUserAgentBtn">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rk-panel">
                <header class="mb-3">
                    <h2 class="rk-panel-head">らじる★らじる番組表取得のアクセス制御</h2>
                </header>
                <div class="content">
                    <div class="md:hidden">
                        <div class="field">
                            <label class="label">最小待機時間（ミリ秒）</label>
                            <div class="control">
                                <input class="input" type="number" min="0" max="60000" step="1" id="radiru-api-min-request-interval-ms" value="@AppConfigurationService.RadiruApiMinRequestIntervalMs">
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">ランダム揺らぎ（ミリ秒）</label>
                            <div class="control">
                                <input class="input" type="number" min="0" max="60000" step="1" id="radiru-api-request-jitter-ms" value="@AppConfigurationService.RadiruApiRequestJitterMs">
                            </div>
                        </div>
                        <div class="field">
                            <div class="control">
                                <button class="button is-primary" id="update-radiru-request-settings-btn">保存</button>
                            </div>
                        </div>
                    </div>

                    <div class="hidden md:block">
                        <div class="columns is-multiline is-desktop">
                            <div class="column">
                                <div class="field">
                                    <label class="label">最小待機時間（ミリ秒）</label>
                                    <div class="control">
                                        <input class="input" type="number" min="0" max="60000" step="1" id="radiru-api-min-request-interval-ms-desktop" value="@AppConfigurationService.RadiruApiMinRequestIntervalMs">
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label">ランダム揺らぎ（ミリ秒）</label>
                                    <div class="control">
                                        <input class="input" type="number" min="0" max="60000" step="1" id="radiru-api-request-jitter-ms-desktop" value="@AppConfigurationService.RadiruApiRequestJitterMs">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="field">
                            <div class="control">
                                <button class="button is-primary" id="update-radiru-request-settings-btn-desktop">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rk-panel">
                <header class="mb-3">
                    <h2 class="rk-panel-head">監視関連の詳細設定</h2>
                </header>
                <div class="content">
                    <div class="md:hidden">
                        <div class="field">
                            <label class="label">ログ保持日数</label>
                            <div class="control">
                                <input class="input" type="number" min="1" max="3650" step="1" id="log-retention-days-value" value="@AppConfigurationService.LogRetentionDays">
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">空き容量チェック間隔（分）</label>
                            <div class="control">
                                <input class="input" type="number" min="1" max="1440" step="1" id="storage-low-space-check-interval-minutes-value" value="@AppConfigurationService.StorageLowSpaceCheckIntervalMinutes">
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">通知クールダウン（時間）</label>
                            <div class="control">
                                <input class="input" type="number" min="1" max="168" step="1" id="storage-low-space-notification-cooldown-hours-value" value="@AppConfigurationService.StorageLowSpaceNotificationCooldownHours">
                            </div>
                        </div>
                        <div class="field">
                            <div class="control">
                                <button class="button is-primary" id="update-monitoring-advanced-btn">保存</button>
                            </div>
                        </div>
                    </div>

                    <div class="hidden md:block">
                        <div class="columns is-multiline is-desktop">
                            <div class="column">
                                <div class="field">
                                    <label class="label">ログ保持日数</label>
                                    <div class="control">
                                        <input class="input" type="number" min="1" max="3650" step="1" id="log-retention-days-value-desktop" value="@AppConfigurationService.LogRetentionDays">
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label">空き容量チェック間隔（分）</label>
                                    <div class="control">
                                        <input class="input" type="number" min="1" max="1440" step="1" id="storage-low-space-check-interval-minutes-value-desktop" value="@AppConfigurationService.StorageLowSpaceCheckIntervalMinutes">
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label">通知クールダウン（時間）</label>
                                    <div class="control">
                                        <input class="input" type="number" min="1" max="168" step="1" id="storage-low-space-notification-cooldown-hours-value-desktop" value="@AppConfigurationService.StorageLowSpaceNotificationCooldownHours">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="field">
                            <div class="control">
                                <button class="button is-primary" id="update-monitoring-advanced-btn-desktop">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="setting-panel-tags" class="hidden">
            <div class="rk-panel mb-5">
                <div class="field is-grouped">
                    <div class="control is-expanded">
                        <input class="input" id="tag-create-name-setting" type="text" placeholder="新規タグ名">
                    </div>
                    <div class="control">
                        <button class="button is-link" id="tag-create-button-setting">作成</button>
                    </div>
                </div>
            </div>

            <div class="rk-table-wrap">
                <table class="table is-fullwidth">
                    <thead>
                    <tr>
                        <th>タグ名</th>
                        <th>利用件数</th>
                        <th>作成日</th>
                        <th class="tag-actions-col">操作</th>
                    </tr>
                    </thead>
                    <tbody id="tag-table-body-setting"></tbody>
                    <template id="tag-table-row-template-setting">
                        <tr>
                            <td class="tag-name"></td>
                            <td class="tag-count"></td>
                            <td class="tag-created"></td>
                            <td class="tag-actions-col">
                                <div class="is-flex is-justify-content-flex-end" style="gap:0.35rem;">
                                    <button class="button is-small is-light tag-action-button" title="操作" aria-label="操作">
                                        <span class="icon is-small"><i class="fas fa-gear"></i></span>
                                    </button>
                                    <button class="button is-small is-danger is-light tag-delete-inline-button" title="削除" aria-label="削除">
                                        <span class="icon is-small"><i class="fas fa-trash"></i></span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </table>
            </div>
        </div>

        <div id="setting-panel-external-import" class="hidden">
            <div class="rk-panel mb-5">
                <header class="mb-3">
                    <h2 class="rk-panel-head">外部音声ファイル取り込み</h2>
                </header>
                <div class="content">
                    <div class="rk-setting-summary mb-4">
                        <p>録音保存先フォルダ配下の未登録音声ファイルをスキャンし、編集して録音済み番組へ登録します。</p>
                        <p>CSVの出力・取込にも対応しています。取込時は候補一覧をクリアしてCSV内容で置き換えます。</p>
                    </div>

                    <div class="field mb-4">
                        <label class="label">ファイル更新日時のタイムゾーンID</label>
                        <div class="field has-addons">
                            <div class="control is-expanded">
                                <div class="select is-fullwidth">
                                    <select id="external-import-timezone-id" aria-label="外部取込タイムゾーン">
                                        @{
                                            var timeZones = TimeZoneInfo.GetSystemTimeZones().OrderBy(tz => tz.Id).ToList();
                                        }
                                        @foreach (var tz in timeZones)
                                        {
                                            if (tz.Id == AppConfigurationService.ExternalImportFileTimeZoneId)
                                            {
                                                <option value="@tz.Id" selected>
                                                    @($"{tz.Id} ({tz.DisplayName})")
                                                </option>
                                            }
                                            else
                                            {
                                                <option value="@tz.Id">
                                                    @($"{tz.Id} ({tz.DisplayName})")
                                                </option>
                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="control">
                                <button type="button" class="button is-light" id="external-import-timezone-save-btn">保存</button>
                            </div>
                        </div>
                        <p class="help">
                            ファイル名/テンプレートから日時が取得できない場合に、ファイル更新日時をこのタイムゾーンとして解釈します。
                            初期値は日本標準時（@RadiKeep.Logics.Primitives.JapanTimeZone.Resolve().Id）です。
                        </p>
                    </div>

                    <div class="field is-grouped is-flex-wrap-wrap mb-3" style="gap:0.5rem;">
                        <label class="checkbox is-flex is-align-items-center mr-3" style="gap:0.4rem;">
                            <input type="checkbox" id="external-import-apply-default-tag" checked>
                            <span>「外部取込」タグを初期付与する</span>
                        </label>
                        <label class="checkbox is-flex is-align-items-center mr-3" style="gap:0.4rem;">
                            <input type="checkbox" id="external-import-mark-as-listened">
                            <span>視聴済みとして登録する</span>
                        </label>
                    </div>

                    <div class="field is-grouped is-flex-wrap-wrap mb-3" style="gap:0.5rem;">
                        <button type="button" class="button is-link" id="external-import-scan-btn">スキャン開始</button>
                        <button type="button" class="button is-light" id="external-import-export-btn">CSVダウンロード</button>
                        <input type="file" id="external-import-file-input" accept=".csv" class="input" style="max-width: 18rem;">
                        <button type="button" class="button is-light" id="external-import-import-btn">CSV取り込み</button>
                        <button type="button" class="button is-primary" id="external-import-save-btn">保存</button>
                    </div>

                    <p class="is-size-7 has-text-grey mb-2">候補件数: <span id="external-import-total-count">0 件</span></p>
                    <div class="rk-table-wrap">
                        <table class="table is-fullwidth is-hoverable">
                            <thead>
                            <tr>
                                <th style="width:3rem;">
                                    <label class="checkbox">
                                        <input type="checkbox" id="external-import-select-all" aria-label="全選択">
                                    </label>
                                </th>
                                <th>ファイルパス</th>
                                <th>タイトル</th>
                                <th>説明</th>
                                <th>放送局</th>
                                <th>放送日時</th>
                                <th>タグ</th>
                            </tr>
                            </thead>
                            <tbody id="external-import-table-body"></tbody>
                            <template id="external-import-row-template">
                                <tr>
                                    <td>
                                        <label class="checkbox">
                                            <input type="checkbox" class="external-import-select" aria-label="取り込み対象">
                                        </label>
                                    </td>
                                    <td><input class="input external-import-file-path" type="text" readonly></td>
                                    <td><input class="input external-import-title" type="text"></td>
                                    <td><input class="input external-import-description" type="text"></td>
                                    <td><input class="input external-import-station-name" type="text"></td>
                                    <td><input class="input external-import-broadcast-at" type="datetime-local"></td>
                                    <td><input class="input external-import-tags" type="text" placeholder="タグ1, タグ2"></td>
                                </tr>
                            </template>
                        </table>
                    </div>
                    <nav class="pagination mt-4" role="navigation" aria-label="pagination">
                        <ul class="pagination-list" id="external-import-pagination-list"></ul>
                    </nav>
                </div>
            </div>

        </div>

        <div id="setting-panel-maintenance" class="hidden">
            <div class="rk-panel mb-5">
                <header class="mb-3">
                    <h2 class="rk-panel-head">録音データ整合性メンテナンス</h2>
                </header>
                <div class="content">
                    <div class="rk-setting-summary mb-4">
                        <p>DBには存在するがファイルが見つからない録音レコードを抽出し、同名ファイルへの再紐付けやDB削除を行います。</p>
                    </div>

                    <div class="field is-grouped is-flex-wrap-wrap mb-3" style="gap:0.5rem;">
                        <button type="button" class="button is-link" id="recording-maintenance-scan-btn">欠損レコードを抽出</button>
                        <button type="button" class="button is-info" id="recording-maintenance-relink-btn">同名ファイルへ再紐付け</button>
                        <button type="button" class="button is-danger is-light" id="recording-maintenance-delete-btn">欠損レコードをDB削除</button>
                    </div>

                    <p class="is-size-7 has-text-grey mb-2">欠損件数: <span id="recording-maintenance-total-count">0 件</span></p>
                    <div class="rk-table-wrap">
                        <table class="table is-fullwidth is-hoverable">
                            <thead>
                                <tr>
                                    <th style="width:3rem;">
                                        <label class="checkbox">
                                            <input type="checkbox" id="recording-maintenance-select-all" aria-label="全選択">
                                        </label>
                                    </th>
                                    <th>タイトル</th>
                                    <th>放送局</th>
                                    <th>登録パス</th>
                                    <th>候補数</th>
                                    <th>候補例</th>
                                </tr>
                            </thead>
                            <tbody id="recording-maintenance-table-body"></tbody>
                            <template id="recording-maintenance-row-template">
                                <tr>
                                    <td>
                                        <label class="checkbox">
                                            <input type="checkbox" class="recording-maintenance-select" aria-label="対象選択">
                                        </label>
                                    </td>
                                    <td class="recording-maintenance-title"></td>
                                    <td class="recording-maintenance-station"></td>
                                    <td class="recording-maintenance-path"></td>
                                    <td class="recording-maintenance-candidates-count"></td>
                                    <td class="recording-maintenance-candidates"></td>
                                </tr>
                            </template>
                        </table>
                    </div>
                </div>
            </div>
        </div>
</section>



<div class="modal" id="tag-manage-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">タグ操作</p>
            <button class="delete" aria-label="close" id="tag-modal-close"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">タグ名</label>
                <p id="tag-modal-current-name" class="has-text-weight-semibold"></p>
            </div>
            <hr class="my-4"/>
            <div class="field mt-2">
                <label class="label">タグ名変更</label>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input class="input" id="tag-modal-rename-input" type="text" placeholder="新しいタグ名">
                    </div>
                    <div class="control">
                        <button class="button is-info" id="tag-modal-rename-button">リネーム</button>
                    </div>
                </div>
            </div>
            <hr class="my-4"/>
            <div class="field mt-2">
                <label class="label">タグ統合</label>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <div class="select is-fullwidth">
                            <select id="tag-modal-merge-select"></select>
                        </div>
                    </div>
                    <div class="control">
                        <button class="button is-warning" id="tag-modal-merge-button">統合</button>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- 保存結果トースト -->
<div class="rk-toast" id="result-toast" role="status" aria-live="polite" aria-atomic="true">
    <div class="rk-toast-body">
        <span id="result-toast-message">保存しました。</span>
        <button class="delete" aria-label="close" id="result-toast-close"></button>
    </div>
</div>

<!-- モーダル -->
<div class="modal" id="result-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title" id="modal-title">タイトル</p>
            <button class="delete" aria-label="close" id="modal-close"></button>
        </header>
        <section class="modal-card-body">
            <p id="modal-message">メッセージ</p>
        </section>
        <footer class="modal-card-foot">
            <button class="button" id="modal-close-footer">閉じる</button>
        </footer>
    </div>
</div>

@section Scripts {
    <script type="module" src="~/js/setting.js" asp-append-version="true"></script>
}



